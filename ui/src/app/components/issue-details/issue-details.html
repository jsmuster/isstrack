<!-- Issue Details Component -->
<div class="issue-details-container" role="main" aria-label="Issue details section">
  <main class="body">
    <!-- Sidebar Navigation -->
    <app-sidebar></app-sidebar>

    <!-- Main Content Area -->
    <main class="main-content" role="region" aria-label="Issue details content">
      <!-- Header -->
      <header class="content-header" role="banner">
        <div class="header-left">
          <h2 class="page-title">Project Workspace</h2>
          <div class="owner-badge">OWNER</div>
        </div>
        <div class="header-right">
          <!-- Search Bar -->
          <div class="search-wrapper">
            <img class="search-icon" alt="" src="/assets/images/i6.svg" />
            <input
              class="search-input"
              type="search"
              placeholder="Search issues..."
              aria-label="Search issues"
            />
          </div>
          <button class="notification-button" type="button" (click)="toggleNotifications()">
            <img class="header-icon" alt="" src="/assets/images/div1.svg" />
          </button>
          <img class="header-button-icon" alt="" src="/assets/images/button.svg" />
          <div class="notification-panel" *ngIf="showNotifications()">
            <div class="notification-header">Notifications</div>
            <div class="notification-item" *ngFor="let item of notifications">
              <div class="notification-message">{{ item.message }}</div>
              <div class="notification-time">{{ item.time }}</div>
            </div>
          </div>
        </div>
      </header>

      <!-- Main Content -->
      <div class="content-area">
        <div class="issue-container">
          <!-- Issue Number and Title -->
           <div class="issue-header">
             <div class="issue-number-section">
               <button class="back-button" type="button" (click)="onGoBack()" aria-label="Go back to issues">
                 <img class="issue-icon" alt="Back" src="/assets/images/Vector.svg" />
               </button>
               <h3 class="issue-number">Issue #{{ issueData().id }}</h3>
             </div>
           </div>

          <!-- Content Grid -->
          <div class="content-grid">
            <!-- Main Content Column -->
            <div class="main-column">
              <!-- Issue Title, Properties & Tags -->
              <section class="issue-title-section" role="region" aria-label="Issue title">
                <h2 class="issue-title">{{ issueData().title }}</h2>

                <div class="issue-properties">
                  <div class="property-row">
                    <div class="property-item">
                      <label class="property-label">Status</label>
                      <app-dropdown
                        [options]="statusOptions"
                        ariaLabel="Issue status"
                        [value]="issueData().status"
                        (valueChange)="onStatusChange($event)"
                      ></app-dropdown>
                    </div>

                    <div class="property-item">
                      <label class="property-label">Priority</label>
                      <app-dropdown
                        [options]="priorityOptions"
                        ariaLabel="Issue priority"
                        [value]="issueData().priority"
                        (valueChange)="onPriorityChange($event)"
                      ></app-dropdown>
                    </div>

                    <div class="property-item">
                      <label class="property-label">Assignee</label>
                      <app-dropdown
                        [options]="assignees()"
                        ariaLabel="Issue assignee"
                        [value]="'' + (issue()?.assigneeUserId ?? '')"
                        (valueChange)="onAssigneeChange($event)"
                      ></app-dropdown>
                    </div>
                  </div>
                </div>

                <div class="tags-row">
                  <h3 class="tags-title">Tags</h3>
                  <div class="tags-list">
                    <span *ngFor="let tag of issueData().tags" [class]="'tag-badge ' + getTagColor(tag)">
                      {{ tag }}
                    </span>
                    <button
                      class="add-tag-button"
                      type="button"
                      (click)="onAddTagPrompt()"
                      aria-label="Add tag"
                    >
                      <img class="add-icon" alt="" src="/assets/images/i7.svg" />
                      <span>Add tag</span>
                    </button>
                  </div>
                </div>
              </section>

              <!-- Description Section -->
              <section class="description-section" role="region" aria-label="Issue description">
                <div class="section-header">
                  <h3 class="section-title">Description</h3>
                  <button
                    class="edit-button"
                    type="button"
                    (click)="onEditDescription()"
                    *ngIf="!isEditingDescription()"
                    aria-label="Edit description"
                  >
                    <img class="edit-icon" alt="" src="/assets/images/i8.svg" />
                    <span>Edit</span>
                  </button>
                </div>
                <div class="description-content" *ngIf="!isEditingDescription()">
                  <quill-view-html
                    class="description-view"
                    [content]="issueData().description"
                    theme="snow"
                    [sanitize]="true"
                  ></quill-view-html>
                </div>
                <div class="description-editor" *ngIf="isEditingDescription()">
                  <quill-editor
                    class="description-quill"
                    [ngModel]="descriptionDraft()"
                    (ngModelChange)="descriptionDraft.set($event)"
                    [modules]="quillModules"
                    theme="snow"
                  ></quill-editor>
                  <div class="description-actions">
                    <button
                      class="description-button cancel"
                      type="button"
                      (click)="onCancelDescriptionEdit()"
                    >
                      Cancel
                    </button>
                    <button
                      class="description-button save"
                      type="button"
                      (click)="onSaveDescription()"
                      [disabled]="isSavingDescription()"
                    >
                      Save
                    </button>
                  </div>
                </div>
              </section>

              <!-- Comments Section -->
              <section class="comments-section" role="region" aria-label="Comments">
                <div class="section-header">
                  <h3 class="section-title">{{ commentsSummaryLabel() }}</h3>
                </div>

                <!-- Add Comment Form -->
                <div class="add-comment-form">
                  <div class="comment-input-wrapper">
                    <img class="user-avatar-small" alt="Your avatar" src="/assets/images/img.svg" />
                    <div class="comment-input-group">
                      <textarea
                        #commentTextarea
                        class="comment-textarea"
                        placeholder="Add a comment..."
                        [(ngModel)]="newComment"
                        (input)="adjustCommentHeight(commentTextarea)"
                        aria-label="Add a comment"
                      ></textarea>
                      <div class="comment-actions">
                        <button
                          class="comment-button"
                          type="button"
                          (click)="onAddComment()"
                          [disabled]="!newComment"
                          aria-label="Post comment"
                        >
                          Comment
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Comments List -->
                <div class="comments-list">
                  <div *ngFor="let comment of comments()" class="comment-item">
                    <img class="comment-avatar" src="/assets/images/img.svg" alt="Comment author" />
                    <div class="comment-content">
                      <div class="comment-header">
                        <strong class="comment-author">User {{ comment.authorUserId }}</strong>
                        <span class="comment-timestamp">{{ formatTimestamp(comment.createdAt) }}</span>
                        <div
                          class="comment-actions"
                          *ngIf="canManageComment(comment.id) && !isEditingComment(comment.id)"
                        >
                          <button
                            class="comment-action-button"
                            type="button"
                            (click)="onEditComment(comment)"
                          >
                            Edit
                          </button>
                          <button
                            class="comment-action-button danger"
                            type="button"
                            (click)="onDeleteComment(comment.id)"
                          >
                            Delete
                          </button>
                        </div>
                      </div>
                      <div class="comment-edit" *ngIf="isEditingComment(comment.id); else commentBody">
                        <textarea
                          #editCommentTextarea
                          class="comment-edit-textarea"
                          [ngModel]="editingComment()?.body"
                          (ngModelChange)="updateEditingCommentBody($event)"
                          (input)="adjustCommentHeight(editCommentTextarea)"
                          aria-label="Edit comment"
                        ></textarea>
                        <div class="comment-edit-actions">
                          <button
                            class="comment-action-button"
                            type="button"
                            (click)="onCancelCommentEdit()"
                          >
                            Cancel
                          </button>
                          <button
                            class="comment-action-button save"
                            type="button"
                            (click)="onSaveCommentEdit()"
                            [disabled]="editingComment()?.isSaving"
                          >
                            Save
                          </button>
                        </div>
                      </div>
                      <ng-template #commentBody>
                        <p class="comment-text">{{ comment.body }}</p>
                      </ng-template>
                    </div>
                  </div>
                </div>

                <!-- Load More Comments -->
                <button
                  *ngIf="canLoadMoreComments()"
                  class="load-more-button"
                  type="button"
                  (click)="onLoadMoreComments()"
                  aria-label="Load more comments"
                >
                  Load more comments
                </button>
              </section>
            </div>

            <!-- Activity Sidebar Column -->
            <section class="activity-sidebar" role="region" aria-label="Activity timeline">
              <div class="section-header">
                <h3 class="section-title">Activity</h3>
              </div>
              <div class="activity-list">
                <activity-item
                  *ngFor="let item of activityItems()"
                  [activityType]="getActivityType(item.message)"
                  [actorLabel]="'User ' + item.actorUserId"
                  [message]="item.message"
                  [hoursAgo]="formatTimestamp(item.createdAt)"
                ></activity-item>
              </div>
              <button
                class="load-more-button"
                type="button"
                (click)="onLoadMoreActivity()"
                aria-label="Load more activity"
              >
                Load more activity
              </button>
            </section>
          </div>
        </div>
      </div>
    </main>
  </main>
</div>
